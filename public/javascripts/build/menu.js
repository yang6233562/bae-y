KISSY.add("menu/base",function(a,b,c,d,e){function h(a){this.get("view").setAriaActiveDescendant(a.newVal)}var f=b.KeyCodes,g=c.Container.extend({isMenu:1,_onSetHighlightedItem:function(a,b){var c;a&&(c=b.prevVal)&&c.set("highlighted",!1,{data:{byPassSetHighlightedItem:1}})},_onSetVisible:function(a){g.superclass._onSetVisible.apply(this,arguments);var c;!a&&(c=this.get("highlightedItem"))&&c.set("highlighted",!1)},bindUI:function(){var a=this;a.on("afterHighlightedItemChange",h,a)},getRootMenu:function(){return this},handleMouseEnter:function(){g.superclass.handleMouseEnter.apply(this,arguments);var a=this.getRootMenu();a&&a._popupAutoHideTimer&&(clearTimeout(a._popupAutoHideTimer),a._popupAutoHideTimer=null),this.get("focusable")&&this.set("focused",!0)},handleBlur:function(a){g.superclass.handleBlur.call(this,a);var b;(b=this.get("highlightedItem"))&&b.set("highlighted",!1)},_getNextEnabledHighlighted:function(a,b){var c=this.get("children"),d=c.length,f=a;do{var g=c[a];if(!g.get("disabled")&&g.get("visible")!==!1)return c[a];a=(a+b+d)%d}while(a!=f);return e},handleKeyEventInternal:function(b){var c=this.get("highlightedItem");if(c&&c.handleKeydown(b))return!0;var d=this.get("children"),g=d.length;if(0===g)return e;var h,i,j;switch(b.keyCode){case f.ESC:(c=this.get("highlightedItem"))&&c.set("highlighted",!1);break;case f.HOME:j=this._getNextEnabledHighlighted(0,1);break;case f.END:j=this._getNextEnabledHighlighted(g-1,-1);break;case f.UP:c?(h=a.indexOf(c,d),i=(h-1+g)%g):i=g-1,j=this._getNextEnabledHighlighted(i,-1);break;case f.DOWN:c?(h=a.indexOf(c,d),i=(h+1+g)%g):i=0,j=this._getNextEnabledHighlighted(i,1)}return j?(j.set("highlighted",!0,{data:{fromKeyboard:1}}),!0):e},containsElement:function(a){var b=this;if(b.get("visible")===!1||!b.get("view"))return!1;if(b.get("view").containsElement(a))return!0;for(var c=b.get("children"),d=0,e=c.length;e>d;d++){var f=c[d];if(f.containsElement&&f.containsElement(a))return!0}return!1}},{ATTRS:{highlightedItem:{value:null},xrender:{value:d},defaultChildCfg:{value:{xclass:"menuitem"}}}},{xclass:"menu",priority:10});return g},{requires:["event","component/base","./menu-render"]}),KISSY.add("menu/filtermenu-render",function(a,b,c){var d=b.all,e="menu-filter",f="menu-filter-label",g="menu-content";return c.extend({getContentElement:function(){return this.get("menuContent")},getKeyEventTarget:function(){return this.get("filterInput")},createDom:function(){var a=this,b=a.get("prefixCls"),c=a.get("el"),h=a.get("filterWrap");h||a.set("filterWrap",h=d("<div class='"+b+e+"'/>").appendTo(c,void 0)),this.get("labelEl")||this.set("labelEl",d("<div class='"+b+f+"'/>").appendTo(h,void 0)),a.get("filterInput")||a.set("filterInput",d("<input autocomplete='off'/>").appendTo(h,void 0)),a.get("menuContent")||a.set("menuContent",d("<div class='"+b+g+"'/>").appendTo(c,void 0))},_onSetLabel:function(a){this.get("labelEl").html(a)}},{ATTRS:{label:{}},HTML_PARSER:{labelEl:function(a){return a.one("."+this.get("prefixCls")+e).one("."+this.get("prefixCls")+f)},filterWrap:function(a){return a.one("."+this.get("prefixCls")+e)},menuContent:function(a){return a.one("."+this.get("prefixCls")+g)},filterInput:function(a){return a.one("."+this.get("prefixCls")+e).one("input")}}})},{requires:["node","./menu-render"]}),KISSY.add("menu/filtermenu",function(a,b,c,d){var e="menuitem-hit",f=c.extend([b.DecorateChild],{bindUI:function(){var a=this,b=a.get("view"),c=b.get("filterInput");c.on("valuechange",a.handleFilterEvent,a)},handleMouseEnter:function(){var a=this;f.superclass.handleMouseEnter.apply(a,arguments),a.getKeyEventTarget()[0].select()},handleFilterEvent:function(){var c,a=this,b=a.get("view"),d=b.get("filterInput"),e=a.get("highlightedItem");a.set("filterStr",d.val()),c=d.val(),a.get("allowMultiple")&&(c=c.replace(/^.+,/,"")),!c&&e?e.set("highlighted",!1):!c||e&&e.get("visible")||(e=a._getNextEnabledHighlighted(0,1),e&&e.set("highlighted",!0))},_onSetFilterStr:function(a){this.filterItems(a)},filterItems:function(b){var c=this,d=c.get("prefixCls"),f=c.get("view"),g=f.get("labelEl"),h=f.get("filterInput");if(g[b?"hide":"show"](),c.get("allowMultiple")){var j,i=[],k=b.match(/(.+)[,\uff0c]\s*([^\uff0c,]*)/),l=[];if(k&&(l=k[1].split(/[,\uff0c]/)),/[,\uff0c]$/.test(b)){if(i=[],k){i=l,j=l[l.length-1];var m=c.get("highlightedItem"),n=m&&m.get("content");n&&n.indexOf(j)>-1&&j&&(i[i.length-1]=n),h.val(i.join(",")+",")}b=""}else k&&(b=k[2]||""),i=l;var o=c.get("enteredItems");o.length!=i.length&&c.set("enteredItems",i)}var p=c.get("children"),q=b&&new RegExp(a.escapeRegExp(b),"ig");a.each(p,function(a){var c=a.get("content");b?c.indexOf(b)>-1?(a.set("visible",!0),a.get("el").html(c.replace(q,function(a){return"<span class='"+d+e+"'>"+a+"<"+"/span>"}))):a.set("visible",!1):(a.get("el").html(c),a.set("visible",!0))})},reset:function(){var a=this,b=a.get("view");a.set("filterStr",""),a.set("enteredItems",[]);var c=b&&b.get("filterInput");c&&c.val("")},destructor:function(){var a=this.get("view"),b=a&&a.get("filterInput");b&&b.detach()}},{ATTRS:{allowTextSelection:{value:!0},label:{view:1},filterStr:{},enteredItems:{value:[]},allowMultiple:{value:!1},decorateChildCls:{value:"menu-content"},xrender:{value:d}}},{xclass:"filter-menu",priority:20});return f},{requires:["component/base","./base","./filtermenu-render"]}),KISSY.add("menu/menu-render",function(a,b){return b.Render.extend({renderUI:function(){var b=this.get("el");b.attr("role","menu").attr("aria-haspopup",!0),b.attr("id")||b.attr("id",a.guid("ks-menu"))},setAriaActiveDescendant:function(a){var b=this.get("el");if(a){var c=a.get("el"),d=c.attr("id");b.attr("aria-activedescendant",d)}else b.attr("aria-activedescendant","")},containsElement:function(a){var b=this.get("el");return b[0]===a||b.contains(a)}})},{requires:["component/base"]}),KISSY.add("menu",function(a,b,c,d,e,f,g,h,i,j){return b.Render=c,b.Item=d,d.Render=e,b.SubMenu=f,f.Render=g,b.PopupMenu=h,h.Render=i,b.FilterMenu=j,b},{requires:["menu/base","menu/menu-render","menu/menuitem","menu/menuitem-render","menu/submenu","menu/submenu-render","menu/popupmenu","menu/popupmenu-render","menu/filtermenu"]}),KISSY.add("menu/menuitem-render",function(a,b,c,d){function f(a){var c=a.get("el"),f=a.get("prefixCls"),g=c.one("."+f+e);return g||(g=new b("<div class='"+f+e+"'/>").prependTo(c),g.unselectable(d)),g}var e="menuitem-checkbox";return c.Render.extend({createDom:function(){this.get("el").attr({role:"menuitem",id:a.guid("ks-menuitem")})},_onSetChecked:function(a){var b=this,c=b.get("el"),d=b.getCssClassWithState("checked");c[a?"addClass":"removeClass"](d)},_onSetSelected:function(a){var b=this,c=b.get("el"),d=b.getCssClassWithState("selected");c[a?"addClass":"removeClass"](d)},_onSetSelectable:function(a){this.get("el").attr("role",a?"menuitemradio":"menuitem")},_onSetCheckable:function(a){a&&f(this),this.get("el").attr("role",a?"menuitemcheckbox":"menuitem")},containsElement:function(a){var b=this.get("el");return b&&(b[0]==a||b.contains(a))}},{ATTRS:{checkable:{},selected:{},checked:{}},HTML_PARSER:{selectable:function(a){var b=this.getCssClassWithPrefix("menuitem-selectable");return a.hasClass(b)},checkable:function(a){var b=this.getCssClassWithPrefix("menuitem-checkable");return a.hasClass(b)}}})},{requires:["node","component/base"]}),KISSY.add("menu/menuitem",function(a,b,c){var d=a.all,e=b.Controller.extend({isMenuItem:1,handleMouseDown:function(a){e.superclass.handleMouseDown.call(this,a),this.set("highlighted",!0)},performActionInternal:function(){var a=this;return a.get("selectable")&&a.set("selected",!0),a.get("checkable")&&a.set("checked",!a.get("checked")),a.fire("click"),!0},_onSetHighlighted:function(a,b){if(b&&b.byPassSetHighlightedItem||this.get("parent").set("highlightedItem",a?this:null),a){var c=this.get("el"),e=c.parent(function(a){return"visible"!=d(a).css("overflow")},this.get("parent").get("el").parent());if(!e)return;c.scrollIntoView(e,{alignWithTop:!0,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0})}},containsElement:function(a){return this.get("view")&&this.get("view").containsElement(a)}},{ATTRS:{focusable:{value:!1},handleMouseEvents:{value:!1},selectable:{view:1},checkable:{view:1},value:{},checked:{view:1},selected:{view:1},xrender:{value:c}}},{xclass:"menuitem",priority:10});return e},{requires:["component/base","./menuitem-render"]}),KISSY.add("menu/popupmenu-render",function(a,b,c){var d=a.UA;return c.extend([b.ContentBox.Render,b.Position.Render,6===d.ie?b.Shim.Render:null])},{requires:["component/extension","./menu-render"]}),KISSY.add("menu/popupmenu",function(a,b,c,d){var e=c.extend([b.Position,b.Align],{getRootMenu:function(){var b,a=this;do b=a,a=a.get("parent");while(a&&(a.isMenuItem||a.isMenu));return b===this?null:b},handleMouseLeave:function(){e.superclass.handleMouseLeave.apply(this,arguments);var b=this.get("parent");if(b&&b.isSubMenu&&b.clearSubMenuTimers(),this.get("autoHideOnMouseLeave")){var c=this.getRootMenu();c&&(clearTimeout(c._popupAutoHideTimer),c._popupAutoHideTimer=setTimeout(function(){var a;(a=c.get("highlightedItem"))&&a.set("highlighted",!1)},1e3*this.get("parent").get("menuDelay")))}},isPopupMenu:1,handleBlur:function(){var a=this;e.superclass.handleBlur.apply(a,arguments),a.hide()}},{ATTRS:{focusable:{value:!1},autoHideOnMouseLeave:{},xrender:{value:d}}},{xclass:"popupmenu",priority:20});return e},{requires:["component/extension","./base","./popupmenu-render"]}),KISSY.add("menu/submenu-render",function(a,b){var c,d='<span class="{prefixCls}menuitem-content"></span>',e='<span class="{prefixCls}submenu-arrow">\u25ba</span>';return c=b.extend({createDom:function(){var b=this,c=b.get("el");c.attr("aria-haspopup","true").append(a.substitute(e,{prefixCls:b.get("prefixCls")}))}},{ATTRS:{arrowEl:{},contentEl:{valueFn:function(){return a.all(a.substitute(d,{prefixCls:this.get("prefixCls")}))}}},HTML_PARSER:{contentEl:function(a){return a.children("."+this.get("prefixCls")+"menuitem-content")}}})},{requires:["./menuitem-render"]}),KISSY.add("menu/submenu",function(a,b,c,d,e){function f(a){var b=a.target;b!==this&&b.isMenuItem&&a.newVal&&(g(this),this.get("highlighted")||(this.set("highlighted",!0),b.set("highlighted",!1),b.set("highlighted",!0)))}function g(a){var b,c;(b=a.dismissTimer_)&&(b.cancel(),a.dismissTimer_=null),(c=a.showTimer_)&&(c.cancel(),a.showTimer_=null)}function k(a,b){var d=a.get("menu");if(d&&!d.isController){if(!b)return null;d=c.create(d,a),a.setInternal("menu",d)}return d}function l(){var c,d,b=this,e=k(b,1);e&&(c=b.get("el"),d=e.get("align"),delete d.node,d=a.clone(d),d.node=c,d.points=d.points||["tr","tl"],e.set("align",d),e.show(),c.attr("aria-haspopup",e.get("el").attr("id")))}function m(){var a=k(this);a&&a.hide()}var h=b.KeyCodes,i=.15,j=d.extend([c.DecorateChild],{isSubMenu:1,clearSubMenuTimers:function(){g(this)},bindUI:function(){this.on("afterHighlightedChange",f,this)},handleMouseLeave:function(){var b=this;b.set("highlighted",!1,{data:{fromMouse:1}}),g(b);var c=k(b);c&&c.get("visible")&&(b.dismissTimer_=a.later(m,1e3*b.get("menuDelay"),!1,b))},handleMouseEnter:function(){var b=this;b.set("highlighted",!0,{data:{fromMouse:1}}),g(b);var c=k(b);c&&c.get("visible")||(b.showTimer_=a.later(l,1e3*b.get("menuDelay"),!1,b))},_onSetHighlighted:function(a,b){var c=this;b&&(j.superclass._onSetHighlighted.apply(this,arguments),b.fromMouse||(a&&!b.fromKeyboard?l.call(c):a||m.call(c)))},performActionInternal:function(){var a=this;l.call(a),j.superclass.performActionInternal.apply(a,arguments)},handleKeydown:function(a){var e,f,c=this,d=k(c),g=d&&d.get("visible"),i=a.keyCode;if(g)if(d.handleKeydown(a));else{if(i!=h.LEFT)return void 0;c.set("highlighted",!1),c.set("highlighted",!0,{data:{fromKeyboard:1}})}else{if(i!=h.RIGHT)return a.keyCode==b.KeyCodes.ENTER?this.performActionInternal(a):void 0;l.call(c),d=k(c),d&&(e=d.get("children"),(f=e[0])&&f.set("highlighted",!0,{data:{fromKeyboard:1}}))}return!0},containsElement:function(a){var b=k(this);return b&&b.containsElement(a)},decorateChildrenInternal:function(a,b){b.css("top","-9999").prependTo(b[0].ownerDocument.body);var d=this;d.setInternal("menu",c.DecorateChild.prototype.decorateChildrenInternal.call(d,a,b,d.get("menu")))},destructor:function(){var a=this,b=k(a);g(a),b&&b.destroy&&b.destroy()}},{ATTRS:{menuDelay:{value:i},menu:{setter:function(a){a&&a.isController&&a.setInternal("parent",this)}},defaultChildCfg:{value:{xclass:"popupmenu"}},decorateChildCls:{value:"popupmenu"},xrender:{value:e}}},{xclass:"submenu",priority:20});return j},{requires:["event","component/base","./menuitem","./submenu-render"]});